upstream smartAttendsystembackend {
    server smartAttendsystembackend:8000;
}
upstream smartAttendsystemfrontend {
    server smartAttendsystemfrontend:3000;
}
upstream pgadmin {
    server pgadmin:80;
}
upstream prometheus {
    server prometheus:9090;
}
upstream grafana {
    server grafana:3000;
}
upstream alertmanager {
    server alertmanager:9093;
}
upstream loki {
    server loki:3100;
}
upstream jaeger {
    server jaeger:16686;
}
upstream node-exporter {
    server node-exporter:9100;
}
server {
    listen 80;

    location /smartAttend/ {
        proxy_pass http://smartAttendsystembackend/; 
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # Add headers for WebSocket support
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        
        # Increase timeouts for long-running connections
        proxy_read_timeout 3600s;
        proxy_send_timeout 3600s;
    }      location /pgadmin/ {
        proxy_pass http://pgadmin/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Script-Name /pgadmin;
        proxy_set_header X-Scheme $scheme;
    }

    # Prometheus - Metrics Collection and Monitoring
    location /prometheus/ {
        proxy_pass http://prometheus/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # Additional headers for Prometheus
        proxy_set_header X-Forwarded-Host $host;
        proxy_set_header X-Forwarded-Server $host;
    }

    # Grafana - Data Visualization and Dashboards
    location /grafana/ {
        proxy_pass http://grafana/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # Grafana specific headers
        proxy_set_header X-Forwarded-Host $host;
        proxy_set_header X-Forwarded-Server $host;
        
        # WebSocket support for live updates
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
    }

    # AlertManager - Alert Management
    location /alertmanager/ {
        proxy_pass http://alertmanager/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Host $host;
    }

    # Loki - Log Aggregation
    location /loki/ {
        proxy_pass http://loki/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # Increase body size for log ingestion
        client_max_body_size 50M;
    }

    # Jaeger - Distributed Tracing
    location /jaeger/ {
        proxy_pass http://jaeger/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # WebSocket support for real-time tracing
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
    }

    # Node Exporter - System Metrics
    location /node-exporter/ {
        proxy_pass http://node-exporter/metrics;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Monitoring Dashboard - Simple HTML page with links to all services
    location /monitoring/ {
        return 200 '<!DOCTYPE html>
<html>
<head>
    <title>Smart Roster - Monitoring Dashboard</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 40px; background: #f5f5f5; }
        .container { max-width: 1200px; margin: 0 auto; background: white; padding: 30px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        h1 { color: #333; text-align: center; margin-bottom: 30px; }
        .service-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-top: 30px; }
        .service-card { background: #f8f9fa; padding: 20px; border-radius: 6px; border-left: 4px solid #007bff; }
        .service-card h3 { margin-top: 0; color: #007bff; }
        .service-card p { color: #666; margin-bottom: 15px; }
        .service-link { display: inline-block; background: #007bff; color: white; padding: 8px 16px; text-decoration: none; border-radius: 4px; }
        .service-link:hover { background: #0056b3; }
        .status { float: right; padding: 4px 8px; border-radius: 12px; font-size: 12px; background: #28a745; color: white; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üöÄ Smart Roster System - Monitoring Dashboard</h1>
        <p style="text-align: center; color: #666;">Complete monitoring and management interface for all system services</p>
        
        <div class="service-grid">
            <div class="service-card">
                <h3>üìä Grafana <span class="status">Active</span></h3>
                <p>Data visualization and dashboards for system metrics</p>
                <a href="/grafana/" class="service-link">Open Grafana</a>
            </div>
            
            <div class="service-card">
                <h3>üìà Prometheus <span class="status">Active</span></h3>
                <p>Metrics collection and monitoring system</p>
                <a href="/prometheus/" class="service-link">Open Prometheus</a>
            </div>
            
            <div class="service-card">
                <h3>üóÑÔ∏è pgAdmin <span class="status">Active</span></h3>
                <p>PostgreSQL database administration interface</p>
                <a href="/pgadmin/" class="service-link">Open pgAdmin</a>
            </div>
            
            <div class="service-card">
                <h3>üö® AlertManager <span class="status">Active</span></h3>
                <p>Alert routing and notification management</p>
                <a href="/alertmanager/" class="service-link">Open AlertManager</a>
            </div>
            
            <div class="service-card">
                <h3>üìã Loki <span class="status">Active</span></h3>
                <p>Log aggregation and search system</p>
                <a href="/loki/" class="service-link">Open Loki</a>
            </div>
            
            <div class="service-card">
                <h3>üîç Jaeger <span class="status">Active</span></h3>
                <p>Distributed tracing and performance monitoring</p>
                <a href="/jaeger/" class="service-link">Open Jaeger</a>
            </div>
            
            <div class="service-card">
                <h3>‚öôÔ∏è Django Admin <span class="status">Active</span></h3>
                <p>Application administration interface</p>
                <a href="/admin/" class="service-link">Open Admin</a>
            </div>
            
            <div class="service-card">
                <h3>üéØ Smart Roster App <span class="status">Active</span></h3>
                <p>Main application interface</p>
                <a href="/" class="service-link">Open Application</a>
            </div>
        </div>
        
        <div style="margin-top: 40px; padding-top: 20px; border-top: 1px solid #eee; text-align: center; color: #666;">
            <p>Last Updated: ' . date('Y-m-d H:i:s') . ' | System Status: All Services Running</p>
        </div>
    </div>
</body>
</html>';
        add_header Content-Type text/html;
    }

    location /admin/ {
        proxy_pass http://smartAttendsystembackend/admin/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # WebSocket support headers
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header SCRIPT_NAME /admin; # <- ADD THIS LINE

        # Timeouts for long-running connections
        proxy_read_timeout 3600s;
        proxy_send_timeout 3600s;
    }
    location / {
        proxy_pass http://smartAttendsystemfrontend;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # Add headers for WebSocket support
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        
        
        # Increase timeouts for long-running connections
        proxy_read_timeout 3600s;
        proxy_send_timeout 3600s;
    }
    
    # Static assets with caching
    location /_next/static/ {
        proxy_pass http://smartAttendsystemfrontend;
        proxy_set_header Host $host;
        
        # Cache static assets for 1 year
        expires 1y;
        add_header Cache-Control "public, immutable";
        add_header X-Cache-Status "STATIC";
    }
        # Security: Deny access to hidden files
    location ~ /\. {
        deny all;
        access_log off;
        log_not_found off;
    }
    location /smartAttend/static/ {
        alias /app/smartAttend/static/;
    }

    location /smartAttend/media/ {
        alias /app/smartAttend/media/;
    }    # Add health check endpoint for nginx healthcheck in docker-compose
    location /health {
        return 200 "healthy\n";
    }

    # System Status API endpoint
    location /api/status {
        return 200 '{
            "status": "healthy",
            "timestamp": "' . date('c') . '",
            "services": {
                "nginx": "running",
                "frontend": "running",
                "backend": "running",
                "database": "running",
                "monitoring": "running"
            },
            "version": "1.0.0"
        }';
        add_header Content-Type application/json;
        add_header Access-Control-Allow-Origin *;
    }

    # Service discovery endpoint
    location /api/services {
        return 200 '{
            "services": [
                {"name": "Grafana", "path": "/grafana/", "description": "Data visualization and dashboards"},
                {"name": "Prometheus", "path": "/prometheus/", "description": "Metrics collection and monitoring"},
                {"name": "pgAdmin", "path": "/pgadmin/", "description": "Database administration"},
                {"name": "AlertManager", "path": "/alertmanager/", "description": "Alert management"},
                {"name": "Loki", "path": "/loki/", "description": "Log aggregation"},
                {"name": "Jaeger", "path": "/jaeger/", "description": "Distributed tracing"},
                {"name": "Django Admin", "path": "/admin/", "description": "Application admin"},
                {"name": "Smart Roster", "path": "/", "description": "Main application"}
            ]
        }';
        add_header Content-Type application/json;
        add_header Access-Control-Allow-Origin *;
    }
}